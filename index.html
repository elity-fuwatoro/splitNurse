<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>看護師受け持ち割り当てアプリ</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* UIの微調整用カスタムCSS */
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'メイリオ', Meiryo, sans-serif;
        }
        .room-checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .room-checkbox-label.checked {
            background-color: #fca5a5; /* red-300 */
            border-color: #ef4444; /* red-500 */
            color: #7f1d1d; /* red-900 */
        }
        .room-checkbox-label:hover {
            background-color: #fee2e2; /* red-100 */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 0.5rem;
            animation: slideIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        /* 主担当部屋が太字になるスタイル */
        .primary-room {
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg">

        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600">看護師受け持ち割り当てアプリ</h1>
            <p class="text-gray-500 mt-2">勤務する看護師と条件を入力して、最適な部屋の割り当て候補を生成します。</p>
        </header>

        <main>
            <!-- 入力セクション -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <!-- 左側：看護師・空き部屋入力 -->
                <div class="space-y-6 bg-gray-50 p-6 rounded-xl border">
                    <div>
                        <label for="nurse-names" class="block text-lg font-semibold mb-2 text-gray-700">1. 看護師名を入力</label>
                        <textarea id="nurse-names" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="田中
佐藤
鈴木
(改行して入力)"></textarea>
                    </div>

                    <div>
                        <h2 class="block text-lg font-semibold mb-2 text-gray-700">2. 空き部屋を選択</h2>
                        <div id="empty-rooms-container" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-7 gap-2">
                            <!-- JavaScriptで部屋番号チェックボックスを生成 -->
                        </div>
                    </div>
                </div>

                <!-- 右側：主担当・実行 -->
                <div class="space-y-6 bg-gray-50 p-6 rounded-xl border">
                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-gray-700">3. 主担当の部屋を設定</h2>
                        <button id="open-primary-modal-button" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition shadow-md">
                            主担当を設定する
                        </button>
                        <div id="primary-assignments-display" class="mt-4 space-y-2 text-sm">
                            <!-- 主担当の設定状況を表示 -->
                        </div>
                    </div>

                    <div class="pt-4 border-t">
                        <h2 class="text-lg font-semibold mb-2 text-gray-700">4. 割り当てを実行</h2>
                        <button id="generate-button" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition shadow-md text-xl">
                            割り当て候補を生成
                        </button>
                    </div>
                </div>
            </div>

            <!-- 結果表示セクション -->
            <div id="result-container" class="mt-10">
                <!-- JavaScriptで結果テーブルを生成 -->
            </div>
        </main>
    </div>

    <!-- 主担当設定モーダル -->
    <div id="primary-nurse-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-button">&times;</span>
            <h2 class="text-2xl font-bold mb-6">主担当設定</h2>
            
            <div class="mb-4">
                <label for="primary-nurse-select" class="block text-md font-medium mb-2">看護師を選択</label>
                <select id="primary-nurse-select" class="w-full p-2 border border-gray-300 rounded-lg">
                    <!-- 看護師名でオプションを生成 -->
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-md font-medium mb-2">主担当の部屋を選択</label>
                <div id="primary-rooms-container" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-7 gap-2">
                    <!-- JavaScriptで部屋番号チェックボックスを生成 -->
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                 <button id="clear-primary-button" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">選択クリア</button>
                <button id="save-primary-button" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">保存</button>
            </div>
        </div>
    </div>


    <script>
        // ES5準拠で記述
        (function() {
            'use strict';

            // --- 定数定義 ---
            var ROOM_LAYOUT = {
                1: [1, 2, 3, 5, 6, 7, 8, 10],
                2: [11, 12, 13, 15, 16, 17, 18],
                3: [20, 21, 22, 23, 25, 26, 27, 28],
                4: [30, 31, 32, 33]
            };
            var ALL_ROOMS = [].concat(ROOM_LAYOUT[1], ROOM_LAYOUT[2], ROOM_LAYOUT[3], ROOM_LAYOUT[4]);
            ALL_ROOMS.sort(function(a, b) { return a - b; });

            // 部屋番号から列を取得するヘルパー
            var roomToColumnMap = {};
            for (var col in ROOM_LAYOUT) {
                if (ROOM_LAYOUT.hasOwnProperty(col)) {
                    for (var i = 0; i < ROOM_LAYOUT[col].length; i++) {
                        roomToColumnMap[ROOM_LAYOUT[col][i]] = parseInt(col, 10);
                    }
                }
            }

            // --- グローバル変数 ---
            var primaryAssignments = {}; // { '看護師名': [部屋番号1, 部屋番号2] }

            // --- DOM要素取得 ---
            var nurseNamesTextarea = document.getElementById('nurse-names');
            var emptyRoomsContainer = document.getElementById('empty-rooms-container');
            var generateButton = document.getElementById('generate-button');
            var resultContainer = document.getElementById('result-container');
            var modal = document.getElementById('primary-nurse-modal');
            var openModalButton = document.getElementById('open-primary-modal-button');
            var closeModalButton = document.getElementById('close-modal-button');
            var primaryNurseSelect = document.getElementById('primary-nurse-select');
            var primaryRoomsContainer = document.getElementById('primary-rooms-container');
            var savePrimaryButton = document.getElementById('save-primary-button');
            var clearPrimaryButton = document.getElementById('clear-primary-button');
            var primaryAssignmentsDisplay = document.getElementById('primary-assignments-display');


            // --- 初期化処理 ---
            function initialize() {
                // 空き部屋チェックボックスを生成
                createRoomCheckboxes(emptyRoomsContainer, 'empty-room', function(checkbox, label) {
                    checkbox.addEventListener('change', function() {
                        label.classList.toggle('checked', checkbox.checked);
                    });
                });
                // モーダル内の部屋チェックボックスを生成
                createRoomCheckboxes(primaryRoomsContainer, 'primary-room', function(checkbox, label) {
                    checkbox.addEventListener('change', function() {
                        label.classList.toggle('bg-blue-200', checkbox.checked);
                    });
                });
                
                setupEventListeners();
            }

            // 部屋チェックボックス生成
            function createRoomCheckboxes(container, namePrefix, callback) {
                container.innerHTML = '';
                for (var i = 0; i < ALL_ROOMS.length; i++) {
                    var room = ALL_ROOMS[i];
                    var label = document.createElement('label');
                    label.className = 'room-checkbox-label';
                    label.setAttribute('for', namePrefix + '-' + room);

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = namePrefix + '-' + room;
                    checkbox.value = room;
                    checkbox.className = 'hidden';

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(room));
                    container.appendChild(label);

                    if (callback) {
                        callback(checkbox, label);
                    }
                }
            }
            
            // --- イベントリスナー設定 ---
            function setupEventListeners() {
                generateButton.addEventListener('click', onGenerateClick);
                openModalButton.addEventListener('click', onOpenModalClick);
                closeModalButton.addEventListener('click', closeModal);
                window.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeModal();
                    }
                });
                savePrimaryButton.addEventListener('click', onSavePrimaryClick);
                primaryNurseSelect.addEventListener('change', onPrimaryNurseSelectChange);
                clearPrimaryButton.addEventListener('click', onClearPrimaryClick);
            }

            // --- モーダル関連の処理 ---
            function onOpenModalClick() {
                var nurses = getNurseNames();
                if (nurses.length === 0) {
                    alert('先に看護師名を入力してください。');
                    return;
                }
                
                primaryNurseSelect.innerHTML = '<option value="">--選択してください--</option>';
                for (var i = 0; i < nurses.length; i++) {
                    var option = document.createElement('option');
                    option.value = nurses[i];
                    option.textContent = nurses[i];
                    primaryNurseSelect.appendChild(option);
                }
                
                resetPrimaryRoomCheckboxes();
                modal.style.display = 'block';
            }

            function closeModal() {
                modal.style.display = 'none';
            }

            function onPrimaryNurseSelectChange() {
                resetPrimaryRoomCheckboxes();
                var selectedNurse = primaryNurseSelect.value;
                if (selectedNurse && primaryAssignments[selectedNurse]) {
                    var assignedRooms = primaryAssignments[selectedNurse];
                    for (var i = 0; i < assignedRooms.length; i++) {
                        var roomNum = assignedRooms[i];
                        var checkbox = document.getElementById('primary-room-' + roomNum);
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.parentNode.classList.add('bg-blue-200');
                        }
                    }
                }
            }
            
            function onClearPrimaryClick() {
                resetPrimaryRoomCheckboxes();
            }

            function onSavePrimaryClick() {
                var selectedNurse = primaryNurseSelect.value;
                if (!selectedNurse) {
                    alert('看護師を選択してください。');
                    return;
                }

                var checkedRooms = [];
                var checkboxes = primaryRoomsContainer.getElementsByTagName('input');
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        checkedRooms.push(parseInt(checkboxes[i].value, 10));
                    }
                }

                // 他の看護師が担当している部屋は設定できない
                for (var nurse in primaryAssignments) {
                    if (nurse !== selectedNurse) {
                        for(var j = 0; j < primaryAssignments[nurse].length; j++) {
                            if (checkedRooms.indexOf(primaryAssignments[nurse][j]) > -1) {
                                alert('エラー: 部屋 ' + primaryAssignments[nurse][j] + ' は ' + nurse + ' さんの主担当に設定されています。');
                                return;
                            }
                        }
                    }
                }
                
                if (checkedRooms.length > 0) {
                    primaryAssignments[selectedNurse] = checkedRooms;
                } else {
                    delete primaryAssignments[selectedNurse];
                }

                updatePrimaryAssignmentsDisplay();
                closeModal();
            }

            function resetPrimaryRoomCheckboxes() {
                var checkboxes = primaryRoomsContainer.getElementsByTagName('input');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = false;
                    checkboxes[i].parentNode.classList.remove('bg-blue-200');
                }
            }

            function updatePrimaryAssignmentsDisplay() {
                primaryAssignmentsDisplay.innerHTML = '';
                var hasAssignments = false;
                for (var nurse in primaryAssignments) {
                    if (primaryAssignments.hasOwnProperty(nurse) && primaryAssignments[nurse].length > 0) {
                        hasAssignments = true;
                        var p = document.createElement('p');
                        var rooms = primaryAssignments[nurse].sort(function(a,b){return a-b;}).join(', ');
                        p.innerHTML = '<span class="font-bold">' + nurse + ':</span> ' + rooms;
                        primaryAssignmentsDisplay.appendChild(p);
                    }
                }
                if (!hasAssignments) {
                    primaryAssignmentsDisplay.innerHTML = '<p class="text-gray-500">主担当は設定されていません。</p>';
                }
            }


            // --- 入力値取得 ---
            function getNurseNames() {
                return nurseNamesTextarea.value.split('\n').map(function(name) {
                    return name.trim();
                }).filter(function(name) {
                    return name.length > 0;
                });
            }

            function getEmptyRooms() {
                var rooms = [];
                var checkboxes = emptyRoomsContainer.getElementsByTagName('input');
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        rooms.push(parseInt(checkboxes[i].value, 10));
                    }
                }
                return rooms;
            }

            // --- 割り当てロジック ---
            function onGenerateClick() {
                var nurses = getNurseNames();
                if (nurses.length < 2) {
                    alert('看護師の数は2人以上で入力してください。');
                    return;
                }

                var emptyRooms = getEmptyRooms();
                
                var availableRooms = ALL_ROOMS.filter(function(room) {
                    return emptyRooms.indexOf(room) === -1;
                });

                // 1. 主担当の割り当て
                var assignments = {};
                var roomsToAssign = availableRooms.slice(); // コピーを作成

                for(var i=0; i<nurses.length; i++){
                    assignments[nurses[i]] = [];
                }
                
                for (var nurseName in primaryAssignments) {
                    if (nurses.indexOf(nurseName) > -1) {
                         // 主担当に設定された部屋が空き部屋でないかチェック
                        for (var k = 0; k < primaryAssignments[nurseName].length; k++) {
                            var pRoom = primaryAssignments[nurseName][k];
                            if(availableRooms.indexOf(pRoom) === -1) {
                                alert('エラー: ' + nurseName + 'さんの主担当部屋(' + pRoom + ')が空き部屋に設定されています。');
                                return;
                            }
                        }
                        assignments[nurseName] = primaryAssignments[nurseName].slice();
                        
                        for (var j = 0; j < primaryAssignments[nurseName].length; j++) {
                             var roomIndex = roomsToAssign.indexOf(primaryAssignments[nurseName][j]);
                             if (roomIndex > -1) {
                                 roomsToAssign.splice(roomIndex, 1);
                             }
                        }
                    }
                }
                
                // 2. 割り当て候補を探索
                var allCombinations = [];
                var initialAssignmentState = {
                    assignments: assignments,
                    unassignedRooms: roomsToAssign.sort(function(a,b){return a-b;})
                };
                
                findCombinationsRecursive(initialAssignmentState, nurses, allCombinations);

                // 3. 候補を評価してフィルタリング
                var scoredCandidates = allCombinations.map(function(assignment) {
                    return {
                        assignment: assignment,
                        score: scoreAssignment(assignment)
                    };
                });
                
                // スコアでソート
                scoredCandidates.sort(function(a, b) {
                    return b.score - a.score;
                });
                
                // 4. 結果表示
                displayResults(scoredCandidates.slice(0, 3));
            }

            // 再帰的に割り当てを探索する関数
            function findCombinationsRecursive(state, nurses, allCombinations) {
                if (allCombinations.length > 500) return; // 無限ループや過剰な計算を防ぐ

                if (state.unassignedRooms.length === 0) {
                    // 全ての部屋が割り当てられた
                    // ここでハードルールのチェック
                    if (isValidAssignment(state.assignments)) {
                         var newAssignment = JSON.parse(JSON.stringify(state.assignments)); // deep copy
                         allCombinations.push(newAssignment);
                    }
                    return;
                }
                
                var roomToAssign = state.unassignedRooms[0];
                var remainingRooms = state.unassignedRooms.slice(1);

                for (var i = 0; i < nurses.length; i++) {
                    var nurse = nurses[i];
                    
                    // 新しい状態を作成
                    var newAssignments = JSON.parse(JSON.stringify(state.assignments));
                    newAssignments[nurse].push(roomToAssign);
                    
                    var newState = {
                        assignments: newAssignments,
                        unassignedRooms: remainingRooms
                    };
                    
                    // 枝刈り: 現時点でルール違反なら探索しない
                    if (isPromising(newState.assignments)) {
                        findCombinationsRecursive(newState, nurses, allCombinations);
                    }
                }
            }
            
            // 割り当てが最終的に有効かチェック (ハードルール)
            function isValidAssignment(assignment) {
                var roomCounts = [];
                for(var nurse in assignment) {
                    roomCounts.push(assignment[nurse].length);
                }

                // 部屋数の差が2以内か
                if (Math.max.apply(null, roomCounts) - Math.min.apply(null, roomCounts) > 2) {
                    return false;
                }

                // 全員の担当列が2列以内か (物理的に不可能な場合を除く)
                for (var nurse in assignment) {
                    if (assignment.hasOwnProperty(nurse)) {
                         var columns = getColumnsForNurse(assignment[nurse]);
                         var primaryColumns = getColumnsForNurse(primaryAssignments[nurse] || []);
                         if (columns.length > 2 && primaryColumns.length <= 2) {
                             return false;
                         }
                    }
                }

                return true;
            }

            // 探索の途中で、この先見込みがあるかチェック (枝刈り)
            function isPromising(assignment) {
                // 現時点で担当列が3つ以上になっていたら見込みなし (物理的に不可能な場合を除く)
                for (var nurse in assignment) {
                    if (assignment.hasOwnProperty(nurse)) {
                         var columns = getColumnsForNurse(assignment[nurse]);
                         var primaryColumns = getColumnsForNurse(primaryAssignments[nurse] || []);
                         if (columns.length > 2 && primaryColumns.length <= 2) {
                             return false;
                         }
                    }
                }
                return true;
            }

            // 看護師の担当部屋から担当列のリストを取得
            function getColumnsForNurse(rooms) {
                var columns = {};
                for(var i=0; i<rooms.length; i++) {
                    columns[roomToColumnMap[rooms[i]]] = true;
                }
                return Object.keys(columns).map(Number);
            }

            // 割り当てパターンを評価する関数
            function scoreAssignment(assignment) {
                var score = 0;
                var roomCounts = [];
                
                // 評価項目1, 3
                for (var nurse in assignment) {
                    if (assignment.hasOwnProperty(nurse)) {
                        var rooms = assignment[nurse];
                        roomCounts.push(rooms.length);
                        var columns = getColumnsForNurse(rooms);

                        // 評価1: 担当列が1列
                        if (columns.length === 1) {
                            score += 10;
                        }
                        
                        // 評価3: 担当列が2列の場合の組み合わせ
                        if (columns.length === 2) {
                            columns.sort(function(a,b){return a-b;});
                            if ((columns[0] === 1 && columns[1] === 4) || (columns[0] === 2 && columns[1] === 3)) {
                                score += 5;
                            }
                        }
                    }
                }

                // 評価項目2: 部屋数の差
                var maxRooms = Math.max.apply(null, roomCounts);
                var minRooms = Math.min.apply(null, roomCounts);
                var diff = maxRooms - minRooms;
                if (diff === 0) {
                    score += 20;
                } else if (diff === 1) {
                    score += 10;
                }
                
                return score;
            }

            // --- 結果表示 ---
            function displayResults(candidates) {
                resultContainer.innerHTML = '';
                if (candidates.length === 0) {
                    resultContainer.innerHTML = '<div class="text-center p-8 bg-yellow-100 border border-yellow-300 rounded-lg"><h3 class="text-xl font-bold text-yellow-800">条件を満たす割り当て候補が見つかりませんでした。</h3><p class="text-yellow-700 mt-2">看護師の人数や空き部屋、主担当の設定を見直して再度お試しください。</p></div>';
                    return;
                }

                for (var i = 0; i < candidates.length; i++) {
                    var candidate = candidates[i];
                    var assignment = candidate.assignment;
                    var score = candidate.score;

                    var container = document.createElement('div');
                    container.className = 'mb-8 bg-white p-6 rounded-xl shadow-md border';
                    
                    var title = document.createElement('h3');
                    title.className = 'text-2xl font-bold mb-4 text-blue-700';
                    title.textContent = '候補' + (i + 1) + ' (スコア: ' + score + ')';
                    container.appendChild(title);

                    var table = document.createElement('table');
                    table.className = 'w-full text-left border-collapse';
                    
                    var thead = document.createElement('thead');
                    thead.innerHTML = '<tr>' +
                        '<th class="p-3 bg-gray-100 border-b-2 border-gray-200 font-semibold">看護師名</th>' +
                        '<th class="p-3 bg-gray-100 border-b-2 border-gray-200 font-semibold">担当部屋</th>' +
                        '<th class="p-3 bg-gray-100 border-b-2 border-gray-200 font-semibold text-center">部屋数</th>' +
                        '</tr>';
                    table.appendChild(thead);

                    var tbody = document.createElement('tbody');
                    for (var nurse in assignment) {
                        if (assignment.hasOwnProperty(nurse)) {
                            var tr = document.createElement('tr');
                            
                            var tdName = document.createElement('td');
                            tdName.className = 'p-3 border-b border-gray-200';
                            tdName.textContent = nurse;
                            tr.appendChild(tdName);

                            var tdRooms = document.createElement('td');
                            tdRooms.className = 'p-3 border-b border-gray-200';
                            
                            // 部屋番号をソートして表示
                            var nurseRooms = assignment[nurse].sort(function(a,b){return a-b;});
                            var nursePrimaryRooms = primaryAssignments[nurse] || [];

                            var roomsHtml = nurseRooms.map(function(room) {
                                if (nursePrimaryRooms.indexOf(room) > -1) {
                                    return '<span class="primary-room">' + room + '</span>';
                                }
                                return room;
                            }).join(', ');
                            tdRooms.innerHTML = roomsHtml;
                            tr.appendChild(tdRooms);

                            var tdCount = document.createElement('td');
                            tdCount.className = 'p-3 border-b border-gray-200 text-center';
                            tdCount.textContent = assignment[nurse].length;
                            tr.appendChild(tdCount);

                            tbody.appendChild(tr);
                        }
                    }
                    table.appendChild(tbody);
                    container.appendChild(table);
                    resultContainer.appendChild(container);
                }
            }
            
            // --- アプリケーション開始 ---
            initialize();
        })();
    </script>

</body>
</html>
